<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Protocol | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: { brand: { 500: '#6366f1' }, dark: { 950: '#020617' } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: white; overflow: hidden; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
        #app-lock { position: fixed; inset: 0; z-index: 9999; background: rgba(2, 6, 23, 0.85); backdrop-filter: blur(40px); display: flex; align-items: center; justify-content: center; transition: all 1s ease; }
        #app-lock.unlocked { opacity: 0; visibility: hidden; pointer-events: none; transform: scale(1.1); }
    </style>
</head>
<body class="h-screen flex selection:bg-brand-500 selection:text-white">

    <!-- Auth Lock -->
    <div id="app-lock">
        <div class="text-center p-10 glass rounded-[3rem] border-brand-500/20 max-w-sm w-full mx-4 shadow-2xl">
            <img src="/static/logo.png" class="w-20 h-20 mx-auto mb-8 rounded-2xl shadow-2xl">
            <h1 class="text-3xl font-black mb-2 tracking-tight">System Secured</h1>
            <p class="text-slate-500 mb-10 text-sm">Please connect your wallet to access the decentralized labor hub.</p>
            <button onclick="connectWallet()" class="w-full py-4 bg-white text-black rounded-2xl font-black text-lg hover:scale-105 transition-all flex items-center justify-center gap-3">
                <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" class="w-6 h-6">
                Connect Wallet
            </button>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="w-80 bg-black/20 border-r border-white/5 flex flex-col justify-between p-8 backdrop-blur-2xl">
        <div>
            <div class="flex items-center gap-3 mb-16 cursor-pointer" onclick="window.location.href='/'">
                <div class="w-8 h-8 rounded-lg bg-brand-500 flex items-center justify-center font-black">A</div>
                <span class="font-black text-xl tracking-tighter">AGENT HUB</span>
            </div>
            <nav class="space-y-3">
                <button class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl bg-brand-500 text-white font-bold shadow-2xl shadow-brand-500/20 transition-all">Dashboard</button>
                <a href="/docs-ui" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl text-slate-500 hover:text-white transition-all">Protocol Docs</a>
            </nav>
        </div>
        <div class="p-6 glass rounded-3xl">
            <div class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Staked Balance</div>
            <div id="sidebarBalance" class="text-2xl font-bold font-mono tracking-tighter">$0.00</div>
        </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col overflow-hidden">
        <header class="h-24 flex items-center justify-between px-12 border-b border-white/5 bg-black/10 backdrop-blur-md">
            <h2 class="text-xl font-bold tracking-tight">Market Overview</h2>
            <div id="walletBtn" class="px-6 py-2.5 rounded-full border border-white/10 text-xs font-bold text-slate-500 uppercase tracking-widest">Disconnected</div>
        </header>

        <div class="flex-1 overflow-auto p-12 custom-scrollbar">
            <div class="max-w-5xl mx-auto grid grid-cols-12 gap-10">
                
                <div class="col-span-12 lg:col-span-4">
                    <div class="glass p-10 rounded-[2.5rem] sticky top-0">
                        <h3 class="text-lg font-black mb-8">Deploy Request</h3>
                        <form onsubmit="handlePostJob(event)" class="space-y-6">
                            <div>
                                <label class="block text-[10px] font-black text-slate-500 uppercase mb-2">Objective</label>
                                <input type="text" id="jobTitle" class="w-full bg-white/5 border border-white/5 rounded-2xl p-4 focus:border-brand-500 outline-none transition text-sm">
                            </div>
                            <div>
                                <label class="block text-[10px] font-black text-slate-500 uppercase mb-2">Bounty (USDC)</label>
                                <input type="number" id="jobBudget" class="w-full bg-white/5 border border-white/5 rounded-2xl p-4 focus:border-brand-500 outline-none transition text-sm">
                            </div>
                            <button class="w-full py-5 bg-brand-500 text-white rounded-3xl font-black shadow-2xl shadow-brand-500/30 hover:scale-[1.02] transition">Launch Contract</button>
                        </form>
                    </div>
                </div>

                <div class="col-span-12 lg:col-span-8">
                    <div id="jobFeed" class="space-y-4">
                        <!-- Items -->
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    const signer = provider.getSigner();
                    const address = await signer.getAddress();
                    const balance = await provider.getBalance(address);
                    
                    document.getElementById('app-lock').classList.add('unlocked');
                    document.getElementById('walletBtn').innerText = address.substring(0, 10) + '...';
                    document.getElementById('sidebarBalance').innerText = parseFloat(ethers.utils.formatEther(balance)).toFixed(4) + ' ETH';
                    fetchJobs();
                } catch (e) { alert("Auth Failed"); }
            } else { alert("MetaMask Required"); }
        }

        async function handlePostJob(e) {
            e.preventDefault();
            const res = await fetch('/jobs/post', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title: document.getElementById('jobTitle').value, budget: document.getElementById('jobBudget').value})
            });
            if (res.ok) { document.getElementById('jobTitle').value=''; document.getElementById('jobBudget').value=''; fetchJobs(); }
        }

        async function fetchJobs() {
            const res = await fetch('/api/jobs');
            const jobs = await res.json();
            const feed = document.getElementById('jobFeed');
            feed.innerHTML = jobs.length ? '' : '<div class=\"glass p-20 text-center rounded-[3rem] opacity-30\">Genesis Block</div>';
            jobs.forEach(job => {
                feed.insertAdjacentHTML('beforeend', `
                    <div class=\"glass p-8 rounded-[2rem] flex justify-between items-center hover:border-brand-500/30 transition-all\">
                        <div class=\"flex items-center gap-6\">
                            <div class=\"w-12 h-12 rounded-xl bg-brand-500/10 flex items-center justify-center text-brand-500 font-bold\">#${job.id}</div>
                            <div>
                                <div class=\"font-bold text-lg\">${job.title}</div>
                                <div class=\"text-xs text-slate-500 uppercase tracking-widest mt-1\">Escrowed</div>
                            </div>
                        </div>
                        <div class=\"text-right\">
                            <div class=\"text-2xl font-black\">$${job.budget}</div>
                            <div class=\"text-[10px] text-slate-500 uppercase\">USDC</div>
                        </div>
                    </div>
                `);
            });
        }
    </script>
</body>
</html>
